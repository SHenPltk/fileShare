<!DOCTYPE html>
<html>
<head>
    <title>å±€åŸŸç½‘æ–‡ä»¶å…±äº«</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #1877f2; --bg: #f0f2f5; --text: #1c1e21; --danger: #d93025; --selected: #e7f3ff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); user-select: none; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h1 { color: var(--primary); text-align: center; margin: 0 0 10px; }
        .ip-info { text-align: center; color: #65676b; margin-bottom: 20px; font-size: 0.85em; }
        
        .breadcrumb { margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; font-size: 0.9em; }
        .breadcrumb a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .breadcrumb .sep { margin: 0 8px; color: #bec3c9; }

        .batch-bar { display: none; background: var(--selected); padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; border: 1px solid #b3d7ff; }
        .batch-info { font-weight: 600; color: var(--primary); flex-grow: 1; }

        .clipboard-bar { display: none; background: #fff3cd; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; align-items: center; gap: 15px; border: 1px solid #ffeeba; }

        .upload-area { border: 2px dashed var(--primary); padding: 30px; text-align: center; margin-bottom: 20px; border-radius: 12px; background: #f7f9fc; position: relative; transition: 0.3s; }
        .upload-area.dragover { background: #e7f3ff; border-color: #166fe5; transform: scale(1.01); }
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
        .btn-danger { background: #fde8e8; color: var(--danger); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .file-list { border: 1px solid #e4e6eb; border-radius: 8px; background: white; }
        .file-header { display: flex; padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #e4e6eb; font-weight: 600; font-size: 0.85em; color: #65676b; }
        .file-item { display: flex; padding: 10px 15px; align-items: center; border-bottom: 1px solid #e4e6eb; transition: 0.1s; cursor: default; }
        .file-item:last-child { border-bottom: none; }
        .file-item.selected { background: var(--selected); }
        .file-item:hover:not(.selected) { background: #f8f9fa; }
        
        .col-check { width: 30px; flex-shrink: 0; }
        .col-info { flex-grow: 1; display: flex; align-items: center; gap: 12px; overflow: hidden; }
        .col-actions { width: 120px; display: flex; justify-content: flex-end; gap: 8px; }
        
        .file-icon { font-size: 1.3em; flex-shrink: 0; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .is-dir .file-name { color: var(--primary); cursor: pointer; }
        .is-dir .file-name:hover { text-decoration: underline; }

        .action-btn { cursor: pointer; font-size: 1.1em; padding: 5px; border-radius: 4px; border: none; background: none; color: #65676b; }
        .action-btn:hover { background: #e4e6eb; color: var(--primary); }

        .progress-container { width: 100%; background: #e4e6eb; border-radius: 10px; margin-top: 10px; display: none; overflow: hidden; }
        .progress-bar { width: 0%; height: 6px; background: #28a745; transition: width 0.1s; }
        
        .shortcut-tip { text-align: center; font-size: 0.8em; color: #8a8d91; margin-top: 15px; }
        kbd { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; padding: 1px 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-size: 0.9em; color: #65676b;">
                ğŸ‘¤ å½“å‰ç”¨æˆ·: <strong>{{ user }}</strong> 
                {% if is_super %}<span style="color: var(--primary); font-weight: bold;">(è¶…çº§ç®¡ç†å‘˜)</span>{% endif %}
            </div>
            <div>
                {% if 'manage' in perms %}
                    <a href="/admin/users" class="btn btn-outline" style="padding: 4px 10px; font-size: 12px;">âš™ï¸ ç”¨æˆ·ç®¡ç†</a>
                {% endif %}
                {% if not is_super %}
                    <a href="/logout" class="btn btn-danger" style="padding: 4px 10px; font-size: 12px; background: #f0f2f5; color: #65676b;">é€€å‡ºç™»å½•</a>
                {% endif %}
            </div>
        </div>
        <h1>ğŸ“ å±€åŸŸç½‘æ–‡ä»¶å…±äº«</h1>
        <div class="ip-info">å±€åŸŸç½‘è®¿é—®: <strong>http://{{ ip }}:5000</strong></div>
        
        <div class="breadcrumb">
            <a href="/">ğŸ  æ ¹ç›®å½•</a>
            {% for crumb in breadcrumbs %}
                <span class="sep">/</span>
                <a href="/view/{{ crumb.path }}">{{ crumb.name }}</a>
            {% endfor %}
        </div>

        <div class="batch-bar" id="batch-bar">
            <span class="batch-info" id="batch-info">å·²é€‰æ‹© 0 ä¸ªé¡¹ç›®</span>
            <button class="btn btn-primary" onclick="batchDownload()">ğŸ“¥ ä¸‹è½½</button>
            <button class="btn btn-outline" onclick="copyToClipboard('copy')">ğŸ“‹ å¤åˆ¶</button>
            <button class="btn btn-outline" onclick="copyToClipboard('move')">âœ‚ï¸ å‰ªåˆ‡</button>
            <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ åˆ é™¤</button>
            <button class="btn" onclick="clearSelection()">å–æ¶ˆ</button>
        </div>

        <div class="clipboard-bar" id="clipboard-bar">
            <span style="flex-grow: 1;" id="clipboard-info"></span>
            <button class="btn btn-primary" onclick="pasteItems()">ğŸ“‹ ç²˜è´´åˆ°æ­¤å¤„</button>
            <button class="btn" onclick="clearClipboard()">å–æ¶ˆ</button>
        </div>

        <div class="upload-area" id="drop-zone">
            <div style="font-size: 40px; margin-bottom: 10px;">â˜ï¸</div>
            <p style="margin: 5px 0;"><strong>æ‹–æ‹½æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°æ­¤å¤„ä¸Šä¼ </strong></p>
            <p style="color: #65676b; font-size: 0.85em;">æ”¯æŒå¤šæ–‡ä»¶åŠæ–‡ä»¶å¤¹é€’å½’ä¸Šä¼ </p>
            <p id="selected-count" style="color: var(--primary); font-weight: bold; font-size: 0.9em; margin-top: 10px;"></p>
        </div>

        <div class="toolbar">
            {% if 'upload' in perms %}
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">ğŸ“„ é€‰æ‹©æ–‡ä»¶</button>
                <button class="btn btn-primary" onclick="document.getElementById('folder-input').click()">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</button>
                <button class="btn btn-outline" onclick="createNewFolder()">â• æ–°å»ºæ–‡ä»¶å¤¹</button>
                <button class="btn btn-danger" id="start-upload-btn" style="display: none;">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
            {% else %}
                <p style="color: #8a8d91; font-size: 0.9em;">æ‚¨æ²¡æœ‰ä¸Šä¼ æƒé™</p>
            {% endif %}
            
            <!-- éšè—çš„è¾“å…¥æ¡† -->
            <input type="file" id="file-input" multiple style="display: none;">
            <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="status" style="text-align: center; font-size: 0.85em; margin: 5px 0; min-height: 1.2em;"></div>

        <div class="file-list">
            <div class="file-header">
                <div class="col-check"><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></div>
                <div class="col-info">åç§°</div>
                <div class="col-actions">æ“ä½œ</div>
            </div>

            {% if current_path %}
                <div class="file-item">
                    <div class="col-check"></div>
                    {% set parent_path = current_path.rsplit('/', 1)[0] if '/' in current_path else '' %}
                    <a href="{{ '/view/' + parent_path if parent_path else '/' }}" class="col-info" style="text-decoration: none; color: inherit;">
                        <span class="file-icon">ğŸ”™</span>
                        <span class="file-name">.. (è¿”å›ä¸Šçº§)</span>
                    </a>
                    <div class="col-actions"></div>
                </div>
            {% endif %}

            {% for item in items %}
                <div class="file-item {{ 'is-dir' if item.is_dir else '' }}" data-path="{{ item.rel_path }}" data-name="{{ item.name }}" onclick="handleItemClick(event, this)">
                    <div class="col-check"><input type="checkbox" class="item-check" value="{{ item.rel_path }}" onclick="event.stopPropagation(); updateBatchBar();"></div>
                    <div class="col-info">
                        <span class="file-icon">{{ 'ğŸ“' if item.is_dir else 'ğŸ“„' }}</span>
                        {% if item.is_dir %}
                            <a href="/view/{{ item.rel_path }}" class="file-name" onclick="event.stopPropagation();">{{ item.name }}</a>
                        {% else %}
                            <span class="file-name">{{ item.name }}</span>
                        {% endif %}
                    </div>
                    <div class="col-actions">
                        {% if 'download' in perms %}
                            <button onclick="event.stopPropagation(); triggerDownload('{{ item.rel_path }}')" class="action-btn" title="ä¸‹è½½">ğŸ“¥</button>
                        {% endif %}
                        {% if 'manage' in perms %}
                            <button onclick="event.stopPropagation(); renameItem('{{ item.rel_path }}', '{{ item.name }}')" class="action-btn" title="é‡å‘½å">âœï¸</button>
                            <button onclick="event.stopPropagation(); deleteItem('{{ item.rel_path }}', '{{ item.name }}')" class="action-btn del" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="shortcut-tip">
            å¿«æ·é”®: <kbd>Ctrl+A</kbd> å…¨é€‰ | <kbd>Esc</kbd> å–æ¶ˆ | <kbd>F2</kbd> é‡å‘½å | <kbd>Ctrl+C</kbd> å¤åˆ¶ | <kbd>Ctrl+X</kbd> å‰ªåˆ‡ | <kbd>Ctrl+V</kbd> ç²˜è´´ | <kbd>Del</kbd> åˆ é™¤
        </div>
    </div>

    <script>
        const currentPath = "{{ current_path }}";
        let clipboard = JSON.parse(localStorage.getItem('fs_clipboard') || '{"op":null,"paths":[]}');
        let pendingFiles = [];

        if (clipboard.op) showClipboardBar();

        // å¿«æ·é”®
        window.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            const selected = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            if (e.key === 'F2' && selected.length === 1) {
                e.preventDefault();
                const item = document.querySelector(`.item-check[value="${selected[0]}"]`).closest('.file-item');
                renameItem(selected[0], item.dataset.name);
            } else if (e.ctrlKey && e.key === 'c' && selected.length > 0) {
                copyToClipboard('copy');
            } else if (e.ctrlKey && e.key === 'x' && selected.length > 0) {
                copyToClipboard('move');
            } else if (e.ctrlKey && e.key === 'v' && clipboard.op) {
                pasteItems();
            } else if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                const allCheckboxes = document.querySelectorAll('.item-check');
                const allChecked = Array.from(allCheckboxes).every(c => c.checked);
                allCheckboxes.forEach(c => c.checked = !allChecked);
                document.getElementById('select-all').checked = !allChecked;
                updateBatchBar();
            } else if (e.key === 'Delete' && selected.length > 0) {
                batchDelete();
            } else if (e.key === 'Escape') {
                clearSelection();
                if (clipboard.op) clearClipboard();
            }
        });

        function handleItemClick(e, element) {
            const checkbox = element.querySelector('.item-check');
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'A') {
                checkbox.checked = !checkbox.checked;
                element.classList.toggle('selected', checkbox.checked);
                updateBatchBar();
            }
        }

        function updateBatchBar() {
            const checked = document.querySelectorAll('.item-check:checked');
            document.getElementById('batch-bar').style.display = checked.length > 0 ? 'flex' : 'none';
            document.getElementById('batch-info').textContent = `å·²é€‰æ‹© ${checked.length} ä¸ªé¡¹ç›®`;
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.toggle('selected', item.querySelector('.item-check').checked);
            });
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('select-all').checked;
            document.querySelectorAll('.item-check').forEach(c => c.checked = isChecked);
            updateBatchBar();
        }

        function clearSelection() {
            document.querySelectorAll('.item-check').forEach(c => c.checked = false);
            document.getElementById('select-all').checked = false;
            updateBatchBar();
        }

        function copyToClipboard(op) {
            const paths = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            clipboard = { op, paths };
            localStorage.setItem('fs_clipboard', JSON.stringify(clipboard));
            showClipboardBar();
            clearSelection();
        }

        function showClipboardBar() {
            document.getElementById('clipboard-info').textContent = `å·²å‡†å¤‡${clipboard.op === 'copy' ? 'å¤åˆ¶' : 'å‰ªåˆ‡'} ${clipboard.paths.length} ä¸ªé¡¹ç›®`;
            document.getElementById('clipboard-bar').style.display = 'flex';
        }

        function clearClipboard() {
            clipboard = { op: null, paths: [] };
            localStorage.removeItem('fs_clipboard');
            document.getElementById('clipboard-bar').style.display = 'none';
        }

        async function pasteItems() {
            const res = await fetch('/fs_op', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ op: clipboard.op, src_paths: clipboard.paths, dest_dir: currentPath })
            });
            if (res.ok) { clearClipboard(); window.location.reload(); }
            else alert('æ“ä½œå¤±è´¥');
        }

        function triggerDownload(path) {
            const a = document.createElement('a');
            a.href = `/download/${encodeURIComponent(path)}`;
            a.download = '';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function renameItem(relPath, oldName) {
            const newName = prompt("é‡å‘½å:", oldName);
            if (!newName || newName === oldName) return;
            const res = await fetch('/fs_op', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ op: 'rename', src_paths: [relPath], new_name: newName })
            });
            if (res.ok) window.location.reload();
        }

        async function deleteItem(path, name) {
            if (confirm(`ç¡®å®šåˆ é™¤ "${name}" å—ï¼Ÿ`)) {
                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paths: [path] })
                });
                if (res.ok) window.location.reload();
                else alert('åˆ é™¤å¤±è´¥');
            }
        }

        async function batchDelete() {
            const paths = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${paths.length} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) {
                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paths })
                });
                if (res.ok) window.location.reload();
            }
        }

        function batchDownload() {
            const paths = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            paths.forEach((path, i) => setTimeout(() => triggerDownload(path), i * 800));
        }

        // ä¸Šä¼ é€»è¾‘
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const startUploadBtn = document.getElementById('start-upload-btn');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        function updatePendingFiles(files) {
            pendingFiles = Array.from(files);
            document.getElementById('selected-count').textContent = `å·²å‡†å¤‡å¥½ ${pendingFiles.length} ä¸ªé¡¹ç›®`;
            startUploadBtn.style.display = pendingFiles.length > 0 ? 'inline-flex' : 'none';
        }

        fileInput.addEventListener('change', () => updatePendingFiles(fileInput.files));
        folderInput.addEventListener('change', () => updatePendingFiles(folderInput.files));

        startUploadBtn.addEventListener('click', async () => {
            if (pendingFiles.length === 0) return;
            startUploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            
            for (let i = 0; i < pendingFiles.length; i++) {
                const file = pendingFiles[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('path', currentPath);
                if (file.webkitRelativePath) {
                    formData.append('webkitRelativePath', file.webkitRelativePath);
                }

                await new Promise(resolve => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload', true);
                    xhr.upload.onprogress = e => {
                        if (e.lengthComputable) {
                            const p = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = p + '%';
                            status.textContent = `ä¸Šä¼ ä¸­ (${i+1}/${pendingFiles.length}): ${file.name}`;
                        }
                    };
                    xhr.onload = resolve;
                    xhr.send(formData);
                });
            }
            window.location.reload();
        });

        // æ‹–æ‹½ä¸Šä¼ å¢å¼º
        const dropZone = document.getElementById('drop-zone');
        ['dragenter', 'dragover'].forEach(n => dropZone.addEventListener(n, e => {
            e.preventDefault(); dropZone.classList.add('dragover');
        }));
        ['dragleave', 'drop'].forEach(n => dropZone.addEventListener(n, e => {
            e.preventDefault(); dropZone.classList.remove('dragover');
        }));

        dropZone.addEventListener('drop', async e => {
            e.preventDefault();
            const items = e.dataTransfer.items;
            pendingFiles = [];
            
            status.textContent = 'æ­£åœ¨æ‰«ææ–‡ä»¶å¤¹...';
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) {
                    await scanEntry(item, "");
                }
            }
            
            updatePendingFiles(pendingFiles);
            status.textContent = 'æ‰«æå®Œæˆï¼Œç‚¹å‡»â€œå¼€å§‹ä¸Šä¼ â€æŒ‰é’®å¼€å§‹ã€‚';
        });

        async function scanEntry(entry, path) {
            if (entry.isFile) {
                const file = await new Promise(resolve => entry.file(resolve));
                // æ¨¡æ‹Ÿ webkitRelativePath
                Object.defineProperty(file, 'webkitRelativePath', {
                    value: path + file.name
                });
                pendingFiles.push(file);
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise(resolve => reader.readEntries(resolve));
                for (const child of entries) {
                    await scanEntry(child, path + entry.name + "/");
                }
            }
        }

        async function createNewFolder() {
            const name = prompt("æ–‡ä»¶å¤¹åç§°:");
            if (!name) return;
            const res = await fetch('/mkdir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentPath, dirname: name })
            });
            if (res.ok) window.location.reload();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>å±€åŸŸç½‘æ–‡ä»¶å…±äº«</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #1877f2; --bg: #f0f2f5; --text: #1c1e21; --danger: #d93025; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* å¤´éƒ¨ä¸å¯¼èˆª */
        h1 { color: var(--primary); text-align: center; margin: 0 0 10px; }
        .ip-info { text-align: center; color: #65676b; margin-bottom: 20px; font-size: 0.9em; }
        .breadcrumb { margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; font-size: 0.9em; }
        .breadcrumb a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .breadcrumb .sep { margin: 0 8px; color: #bec3c9; }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area { border: 2px dashed var(--primary); padding: 30px; text-align: center; margin-bottom: 20px; border-radius: 12px; background: #f7f9fc; position: relative; cursor: pointer; }
        .upload-area.dragover { background: #e7f3ff; border-color: #166fe5; }
        #file-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 5; }

        /* æ‰¹é‡æ“ä½œæ  */
        .batch-bar { display: none; background: #e7f3ff; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .batch-info { font-weight: 600; color: var(--primary); flex-grow: 1; }

        /* å·¥å…·æ  */
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
        .btn-danger { background: #fde8e8; color: var(--danger); }
        .btn:hover { opacity: 0.85; }

        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list { border: 1px solid #e4e6eb; border-radius: 8px; }
        .file-header { display: flex; padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #e4e6eb; font-weight: 600; font-size: 0.9em; color: #65676b; }
        .file-item { display: flex; padding: 10px 15px; align-items: center; border-bottom: 1px solid #e4e6eb; transition: 0.2s; }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background: #f8f9fa; }
        
        .col-check { width: 30px; flex-shrink: 0; }
        .col-info { flex-grow: 1; display: flex; align-items: center; gap: 12px; overflow: hidden; text-decoration: none; color: inherit; }
        .col-actions { width: 150px; display: flex; justify-content: flex-end; gap: 10px; }
        
        .file-icon { font-size: 1.4em; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .is-dir .file-name { color: var(--primary); }

        .action-btn { cursor: pointer; font-size: 1.1em; padding: 5px; border-radius: 4px; border: none; background: none; color: #65676b; }
        .action-btn:hover { background: #f0f2f5; color: var(--primary); }
        .action-btn.del:hover { color: var(--danger); background: #fde8e8; }

        /* è¿›åº¦æ¡ */
        .progress-container { width: 100%; background: #e4e6eb; border-radius: 10px; margin-top: 10px; display: none; overflow: hidden; }
        .progress-bar { width: 0%; height: 6px; background: #28a745; transition: width 0.1s; }
        
        /* å‰ªè´´æ¿æç¤º */
        .clipboard-bar { display: none; background: #fff3cd; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; align-items: center; gap: 15px; border: 1px solid #ffeeba; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ å±€åŸŸç½‘æ–‡ä»¶å…±äº«</h1>
        <div class="ip-info">å½“å‰ IP: <strong>{{ ip }}</strong></div>
        
        <div class="breadcrumb">
            <a href="/">ğŸ  æ ¹ç›®å½•</a>
            {% for crumb in breadcrumbs %}
                <span class="sep">/</span>
                <a href="/view/{{ crumb.path }}">{{ crumb.name }}</a>
            {% endfor %}
        </div>

        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div class="batch-bar" id="batch-bar">
            <span class="batch-info" id="batch-info">å·²é€‰æ‹© 0 ä¸ªé¡¹ç›®</span>
            <button class="btn btn-primary" onclick="batchDownload()">ğŸ“¥ æ‰¹é‡ä¸‹è½½</button>
            <button class="btn btn-outline" onclick="copyToClipboard('copy')">ğŸ“‹ å¤åˆ¶</button>
            <button class="btn btn-outline" onclick="copyToClipboard('move')">âœ‚ï¸ å‰ªåˆ‡</button>
            <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ åˆ é™¤</button>
            <button class="btn" onclick="clearSelection()">å–æ¶ˆ</button>
        </div>

        <!-- å‰ªè´´æ¿æ“ä½œæ  -->
        <div class="clipboard-bar" id="clipboard-bar">
            <span style="flex-grow: 1;" id="clipboard-info"></span>
            <button class="btn btn-primary" onclick="pasteItems()">ğŸ“‹ ç²˜è´´åˆ°æ­¤å¤„</button>
            <button class="btn" onclick="clearClipboard()">å–æ¶ˆ</button>
        </div>

        <div class="upload-area" id="drop-zone">
            <input type="file" id="file-input" multiple>
            <div style="font-size: 40px;">â˜ï¸</div>
            <p><strong>æ‹–æ‹½æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°æ­¤å¤„</strong></p>
            <p id="selected-count" style="color: var(--primary); font-weight: bold;"></p>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" id="upload-btn">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
            <button class="btn btn-outline" onclick="createNewFolder()">â• æ–°å»ºæ–‡ä»¶å¤¹</button>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="status" style="text-align: center; font-size: 0.9em; margin: 10px 0;"></div>

        <div class="file-list">
            <div class="file-header">
                <div class="col-check"><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></div>
                <div class="col-info">åç§°</div>
                <div class="col-actions">æ“ä½œ</div>
            </div>

            {% if current_path %}
                <div class="file-item">
                    <div class="col-check"></div>
                    {% set parent_path = current_path.rsplit('/', 1)[0] if '/' in current_path else '' %}
                    <a href="{{ '/view/' + parent_path if parent_path else '/' }}" class="col-info">
                        <span class="file-icon">ğŸ”™</span>
                        <span class="file-name">.. (è¿”å›ä¸Šçº§)</span>
                    </a>
                    <div class="col-actions"></div>
                </div>
            {% endif %}

            {% for item in items %}
                <div class="file-item {{ 'is-dir' if item.is_dir else '' }}">
                    <div class="col-check"><input type="checkbox" class="item-check" value="{{ item.rel_path }}" onclick="updateBatchBar()"></div>
                    <a href="{{ '/view/' + item.rel_path if item.is_dir else '/download/' + item.rel_path }}" 
                       class="col-info" {{ '' if item.is_dir else 'download' }}>
                        <span class="file-icon">{{ 'ğŸ“' if item.is_dir else 'ğŸ“„' }}</span>
                        <span class="file-name">{{ item.name }}</span>
                    </a>
                    <div class="col-actions">
                        <a href="/download/{{ item.rel_path }}" download class="action-btn" title="ä¸‹è½½">ğŸ“¥</a>
                        <button onclick="renameItem('{{ item.rel_path }}', '{{ item.name }}')" class="action-btn" title="é‡å‘½å">âœï¸</button>
                        <button onclick="deleteItem('{{ item.rel_path }}', '{{ item.name }}')" class="action-btn del" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        const currentPath = "{{ current_path }}";
        let clipboard = { op: null, paths: [] };

        // åŸºç¡€äº¤äº’
        function updateBatchBar() {
            const checked = document.querySelectorAll('.item-check:checked');
            const bar = document.getElementById('batch-bar');
            document.getElementById('batch-info').textContent = `å·²é€‰æ‹© ${checked.length} ä¸ªé¡¹ç›®`;
            bar.style.display = checked.length > 0 ? 'flex' : 'none';
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('select-all').checked;
            document.querySelectorAll('.item-check').forEach(c => c.checked = isChecked);
            updateBatchBar();
        }

        function clearSelection() {
            document.querySelectorAll('.item-check').forEach(c => c.checked = false);
            document.getElementById('select-all').checked = false;
            updateBatchBar();
        }

        // å‰ªè´´æ¿æ“ä½œ
        function copyToClipboard(op) {
            const paths = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            clipboard = { op, paths };
            document.getElementById('clipboard-info').textContent = `å·²${op === 'copy' ? 'å¤åˆ¶' : 'å‰ªåˆ‡'} ${paths.length} ä¸ªé¡¹ç›®`;
            document.getElementById('clipboard-bar').style.display = 'flex';
            clearSelection();
        }

        function clearClipboard() {
            clipboard = { op: null, paths: [] };
            document.getElementById('clipboard-bar').style.display = 'none';
        }

        async function pasteItems() {
            const res = await fetch('/fs_op', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ op: clipboard.op, src_paths: clipboard.paths, dest_dir: currentPath })
            });
            if (res.ok) {
                clearClipboard();
                window.location.reload();
            } else alert('æ“ä½œå¤±è´¥');
        }

        // æ–‡ä»¶æ“ä½œ
        async function renameItem(relPath, oldName) {
            const newName = prompt("è¯·è¾“å…¥æ–°åç§°:", oldName);
            if (!newName || newName === oldName) return;
            const res = await fetch('/fs_op', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ op: 'rename', src_paths: [relPath], new_name: newName })
            });
            if (res.ok) window.location.reload();
            else alert('é‡å‘½åå¤±è´¥');
        }

        async function deleteItem(path, name) {
            if (confirm(`ç¡®å®šåˆ é™¤ "${name}" å—ï¼Ÿ`)) {
                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paths: [path] })
                });
                if (res.ok) window.location.reload();
            }
        }

        async function batchDelete() {
            const paths = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${paths.length} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) {
                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paths })
                });
                if (res.ok) window.location.reload();
            }
        }

        function batchDownload() {
            const paths = Array.from(document.querySelectorAll('.item-check:checked')).map(c => c.value);
            paths.forEach((path, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = `/download/${encodeURIComponent(path)}`;
                    link.download = '';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, index * 500); // é—´éš”ä¸‹è½½é˜²æ­¢æµè§ˆå™¨æ‹¦æˆª
            });
        }

        // ä¸Šä¼ é€»è¾‘
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const status = document.getElementById('status');

        fileInput.addEventListener('change', () => {
            document.getElementById('selected-count').textContent = `å·²é€‰æ‹© ${fileInput.files.length} ä¸ªé¡¹ç›®`;
        });

        uploadBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) return alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
            
            uploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                formData.append('path', currentPath);
                if (files[i].webkitRelativePath) formData.append('webkitRelativePath', files[i].webkitRelativePath);

                await new Promise((resolve) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload', true);
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const p = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = p + '%';
                            status.textContent = `ä¸Šä¼ ä¸­ (${i+1}/${files.length}): ${files[i].name}`;
                        }
                    };
                    xhr.onload = resolve;
                    xhr.send(formData);
                });
            }
            window.location.reload();
        });

        async function createNewFolder() {
            const name = prompt("æ–‡ä»¶å¤¹åç§°:");
            if (!name) return;
            const res = await fetch('/mkdir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentPath, dirname: name })
            });
            if (res.ok) window.location.reload();
        }

        // æ‹–æ‹½æ”¯æŒ
        const dropZone = document.getElementById('drop-zone');
        ['dragenter', 'dragover'].forEach(n => dropZone.addEventListener(n, e => {
            e.preventDefault(); dropZone.classList.add('dragover');
        }));
        ['dragleave', 'drop'].forEach(n => dropZone.addEventListener(n, e => {
            e.preventDefault(); dropZone.classList.remove('dragover');
        }));
        dropZone.addEventListener('drop', e => {
            fileInput.files = e.dataTransfer.files;
            document.getElementById('selected-count').textContent = `å·²é€‰æ‹© ${fileInput.files.length} ä¸ªé¡¹ç›®`;
        });
    </script>
</body>
</html>
